# Kali Linux Preseed Configuration for Proxmox VE
# This preseed file enables automated installation of Kali Linux on Proxmox
#
# Environment variables can be set during VM creation to customize:
# - KALI_USER: Username (default: kali)
# - KALI_PASSWORD: User password (default: empty, will prompt)
# - KALI_ROOT_PASSWORD: Root password (default: empty, root disabled)
# - KALI_HOSTNAME: Hostname (default: kali)
# - KALI_DOMAIN: Domain (default: localdomain)

# Localization
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# Network configuration (automatic DHCP)
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string ${KALI_HOSTNAME:-kali}
d-i netcfg/get_domain string ${KALI_DOMAIN:-localdomain}
d-i netcfg/wireless_wlan string auto

# Mirror configuration
d-i mirror/country string manual
d-i mirror/http/hostname string http.kali.org
d-i mirror/http/directory string /kali
d-i mirror/http/proxy string

# Clock and time zone
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true

# Partitioning (use entire disk with LVM)
d-i partman-auto/method string lvm
d-i partman-auto-lvm/guided_size string max
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Base system installation
d-i base-installer/kernel/image string linux-image-amd64

# User account setup
# Set to empty to force password prompt during installation
d-i passwd/user-fullname string Kali User
d-i passwd/username string ${KALI_USER:-kali}
d-i passwd/user-password-crypted password ${KALI_PASSWORD_HASH:-}
d-i passwd/user-password-again password ${KALI_PASSWORD:-}

# Root account (disabled by default in Kali)
d-i passwd/root-login boolean false
d-i passwd/root-password-crypted password ${KALI_ROOT_PASSWORD_HASH:-}
d-i passwd/root-password-again password ${KALI_ROOT_PASSWORD:-}

# APT configuration
d-i apt-setup/contrib boolean true
d-i apt-setup/use_mirror boolean true
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string http.kali.org
d-i apt-setup/security_path string /kali-security

# Package selection
tasksel tasksel/first multiselect standard, kali-desktop-core
d-i pkgsel/include string openssh-server sudo qemu-guest-agent
d-i pkgsel/upgrade select safe-upgrade

# Boot loader installation
d-i bootloader-installer/bootdev string default
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

# Finish the installation
d-i finish-install/reboot_in_progress note

# Prevent installation from asking for CD-ROM
d-i cdrom-detect/eject boolean false
d-i cdrom-detect/try-harder boolean true

# Early command to configure SSH access
d-i preseed/early_command string \
  sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null || true

# Late command for additional configuration
d-i preseed/late_command string \
  in-target mkdir -p /etc/sudoers.d; \
  in-target chmod 750 /etc/sudoers.d; \
  in-target bash -c "echo '${KALI_USER:-kali} ALL=(ALL:ALL) NOPASSWD:ALL' > /etc/sudoers.d/${KALI_USER:-kali}"; \
  in-target chmod 440 /etc/sudoers.d/${KALI_USER:-kali}; \
  in-target systemctl enable ssh; \
  in-target systemctl enable qemu-guest-agent; \
  in-target usermod -aG sudo ${KALI_USER:-kali}; \
  in-target sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config; \
  in-target sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Popular console keymap combinations
d-i keyboard-configuration/xkb-keymap select us

# Auto-install kernel
d-i base-installer/kernel/image string linux-image-amd64

# Hardware detection
d-i hw-detect/load_firmware boolean true
